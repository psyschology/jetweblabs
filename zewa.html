import React, { useState, useEffect, useMemo } from 'react';
import { initializeApp } from 'firebase/app';
import { 
    getAuth, 
    onAuthStateChanged, 
    signInWithEmailAndPassword, 
    createUserWithEmailAndPassword,
    signOut
} from 'firebase/auth';
import { 
    getFirestore, 
    collection, 
    onSnapshot, 
    addDoc, 
    doc, 
    updateDoc, 
    deleteDoc,
    query,
    orderBy,
    getDoc,
    setDoc
} from 'firebase/firestore';

// --- Firebase Configuration ---
// IMPORTANT: Replace this with your own Firebase project configuration.
// 1. Go to https://console.firebase.google.com/
// 2. Create a new project.
// 3. Go to Project Settings -> General tab.
// 4. Under "Your apps", click the Web icon (</>).
// 5. Register the app and copy the firebaseConfig object here.
const firebaseConfig = {
  apiKey: "AIzaSyDnvS6nSsbGvB_BMcSw1F1X85C6AxLv1is",
  authDomain: "zewa-736c2.firebaseapp.com",
  projectId: "zewa-736c2",
  storageBucket: "zewa-736c2.firebasestorage.app",
  messagingSenderId: "122013580587",
  appId: "1:122013580587:web:7d2e04032e73fc8acc996e",
  measurementId: "G-5648GMF3PW"
};

// --- Initialize Firebase ---
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);


// --- Helper Components & Icons ---
const StarRating = ({ rating }) => (
    <div className="flex text-yellow-400">
        {[...Array(5)].map((_, i) => (
            <i key={i} className={`fas fa-star ${i < Math.floor(rating) ? '' : 'text-gray-300'}`}></i>
        ))}
    </div>
);

const Spinner = () => (
    <div className="flex justify-center items-center h-full p-8">
        <div className="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-gray-800"></div>
    </div>
);


// --- Admin Panel Components ---

const AdminLogin = () => {
    const [email, setEmail] = useState('');
    const [password, setPassword] = useState('');
    const [error, setError] = useState('');

    const handleLogin = async (e) => {
        e.preventDefault();
        setError('');
        try {
            await signInWithEmailAndPassword(auth, email, password);
            // Auth state change will handle redirect
        } catch (err) {
            setError(err.message);
        }
    };

    return (
        <div className="min-h-screen bg-gray-100 flex items-center justify-center">
            <div className="bg-white p-8 rounded-xl shadow-lg w-full max-w-md">
                <h1 className="text-3xl font-brand font-bold text-center mb-6">Zewa Admin Login</h1>
                <form onSubmit={handleLogin}>
                    <div className="mb-4">
                        <label className="block text-sm font-bold mb-2">Email</label>
                        <input type="email" value={email} onChange={e => setEmail(e.target.value)} className="w-full p-2 border rounded-lg" required />
                    </div>
                    <div className="mb-6">
                        <label className="block text-sm font-bold mb-2">Password</label>
                        <input type="password" value={password} onChange={e => setPassword(e.target.value)} className="w-full p-2 border rounded-lg" required />
                    </div>
                    {error && <p className="text-red-500 text-sm mb-4">{error}</p>}
                    <button type="submit" className="w-full bg-gray-800 text-white font-bold py-3 rounded-lg hover:bg-gray-900 transition-colors">
                        Login
                    </button>
                </form>
            </div>
        </div>
    );
};

const ProductManager = ({ products }) => {
    const [name, setName] = useState('');
    const [price, setPrice] = useState('');
    const [imageUrl, setImageUrl] = useState('');
    const [isEditing, setIsEditing] = useState(null);

    const handleSubmit = async (e) => {
        e.preventDefault();
        if (!name || !price || !imageUrl) return;

        const productData = { name, price: Number(price), imageUrl, createdAt: new Date() };

        try {
            if (isEditing) {
                const productRef = doc(db, 'products', isEditing.id);
                await updateDoc(productRef, { name, price: Number(price), imageUrl });
            } else {
                await addDoc(collection(db, 'products'), productData);
            }
            resetForm();
        } catch (error) {
            console.error("Error saving product: ", error);
        }
    };
    
    const editProduct = (product) => {
        setIsEditing(product);
        setName(product.name);
        setPrice(product.price);
        setImageUrl(product.imageUrl);
    };

    const deleteProduct = async (id) => {
        if (window.confirm("Are you sure you want to delete this product?")) {
            await deleteDoc(doc(db, 'products', id));
        }
    };
    
    const resetForm = () => {
        setName(''); setPrice(''); setImageUrl(''); setIsEditing(null);
    };

    return (
        <div className="bg-white p-6 rounded-lg shadow-md">
            <h2 className="text-2xl font-bold mb-4">{isEditing ? 'Edit Product' : 'Add New Product'}</h2>
            <form onSubmit={handleSubmit} className="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                <input type="text" placeholder="Product Name" value={name} onChange={e => setName(e.target.value)} className="p-2 border rounded-lg" required />
                <input type="number" placeholder="Price (₹)" value={price} onChange={e => setPrice(e.target.value)} className="p-2 border rounded-lg" required />
                <input type="url" placeholder="Image URL" value={imageUrl} onChange={e => setImageUrl(e.target.value)} className="p-2 border rounded-lg" required />
                <div className="flex gap-2">
                    <button type="submit" className="flex-1 bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700">{isEditing ? 'Update' : 'Add'}</button>
                    {isEditing && <button onClick={resetForm} type="button" className="bg-gray-400 text-white font-bold py-2 px-4 rounded-lg hover:bg-gray-500">Cancel</button>}
                </div>
            </form>
            <hr className="my-6" />
            <h3 className="text-xl font-bold mb-4">Existing Products</h3>
            <div className="space-y-2">
                {products.map(p => (
                    <div key={p.id} className="flex items-center justify-between p-2 bg-gray-50 rounded-lg">
                        <img src={p.imageUrl} alt={p.name} className="w-12 h-12 object-cover rounded-md"/>
                        <span className="font-semibold">{p.name}</span>
                        <span>₹{p.price}</span>
                        <div>
                            <button onClick={() => editProduct(p)} className="text-blue-500 mr-2"><i className="fas fa-edit"></i></button>
                            <button onClick={() => deleteProduct(p.id)} className="text-red-500"><i className="fas fa-trash"></i></button>
                        </div>
                    </div>
                ))}
            </div>
        </div>
    );
};

const OrderViewer = ({ orders }) => (
    <div className="bg-white p-6 rounded-lg shadow-md">
        <h2 className="text-2xl font-bold mb-4">Recent Orders</h2>
        <div className="space-y-4">
            {orders.length > 0 ? orders.map(order => (
                <div key={order.id} className="p-4 border rounded-lg">
                    <p className="font-bold">Order ID: <span className="font-normal text-sm">{order.id}</span></p>
                    <p className="font-bold">Date: <span className="font-normal">{new Date(order.createdAt?.toDate()).toLocaleString()}</span></p>
                    <p className="font-bold">Customer: <span className="font-normal">{order.customer.name} ({order.customer.email})</span></p>
                    <p className="font-bold">Total: <span className="font-normal">₹{order.total}</span></p>
                    <details className="mt-2 text-sm">
                        <summary className="cursor-pointer font-semibold">View Details</summary>
                        <p><b>Address:</b> {order.customer.address}, {order.customer.city}, {order.customer.pincode}</p>
                        <ul className="list-disc pl-5 mt-2">
                            {order.items.map(item => <li key={item.id}>{item.name} x {item.quantity}</li>)}
                        </ul>
                    </details>
                </div>
            )) : <p>No orders yet.</p>}
        </div>
    </div>
);

const SettingsManager = ({ settings, setSettings }) => {
    const handleSave = async () => {
        try {
            await setDoc(doc(db, 'settings', 'site'), settings);
            alert('Settings saved!');
        } catch (error) {
            console.error("Error saving settings: ", error);
            alert('Failed to save settings.');
        }
    };
    
    const handleChange = (e) => {
        setSettings({...settings, [e.target.name]: e.target.value });
    };

    return (
        <div className="bg-white p-6 rounded-lg shadow-md">
            <h2 className="text-2xl font-bold mb-4">Site Settings</h2>
            <div className="space-y-4">
                <div>
                    <label className="block font-bold mb-1">Announcement Bar Text</label>
                    <input type="text" name="announcement" value={settings.announcement || ''} onChange={handleChange} className="w-full p-2 border rounded-lg" />
                </div>
                <div>
                    <label className="block font-bold mb-1">Instagram Reel URL</label>
                    <input type="url" name="reelUrl" value={settings.reelUrl || ''} onChange={handleChange} className="w-full p-2 border rounded-lg" />
                </div>
                <button onClick={handleSave} className="bg-green-600 text-white font-bold py-2 px-6 rounded-lg hover:bg-green-700">Save Settings</button>
            </div>
        </div>
    );
};

const AdminDashboard = ({ products, orders, settings, setSettings }) => {
    const [activeTab, setActiveTab] = useState('products');

    return (
        <div className="min-h-screen bg-gray-100 p-4 md:p-8">
            <div className="max-w-6xl mx-auto">
                <div className="flex justify-between items-center mb-6">
                    <h1 className="text-4xl font-brand font-bold">Admin Dashboard</h1>
                    <button onClick={() => signOut(auth)} className="font-bold bg-red-500 text-white py-2 px-4 rounded-lg">Logout</button>
                </div>
                <div className="flex border-b mb-6">
                    <button onClick={() => setActiveTab('products')} className={`py-2 px-4 font-semibold ${activeTab === 'products' ? 'border-b-2 border-gray-800' : ''}`}>Products</button>
                    <button onClick={() => setActiveTab('orders')} className={`py-2 px-4 font-semibold ${activeTab === 'orders' ? 'border-b-2 border-gray-800' : ''}`}>Orders</button>
                    <button onClick={() => setActiveTab('settings')} className={`py-2 px-4 font-semibold ${activeTab === 'settings' ? 'border-b-2 border-gray-800' : ''}`}>Settings</button>
                </div>
                <div>
                    {activeTab === 'products' && <ProductManager products={products} />}
                    {activeTab === 'orders' && <OrderViewer orders={orders} />}
                    {activeTab === 'settings' && <SettingsManager settings={settings} setSettings={setSettings} />}
                </div>
            </div>
        </div>
    );
};

// --- Storefront Components ---

const Header = ({ cartItemCount, setView }) => (
    <header className="bg-white/80 backdrop-blur-lg shadow-sm sticky top-0 z-40">
        <nav className="container mx-auto px-4 sm:px-6 py-3 flex justify-between items-center">
            <a href="#" onClick={() => setView('home')} className="text-3xl md:text-4xl font-brand text-gray-900 font-bold cursor-pointer">Zewa</a>
            <div className="flex items-center space-x-4">
                <a href="#bestsellers" className="hidden md:inline-block text-gray-600 hover:text-pink-500 transition-colors">Shop</a>
                <a href="#reviews" className="hidden md:inline-block text-gray-600 hover:text-pink-500 transition-colors">Reviews</a>
                <button onClick={() => setView('cart')} className="relative">
                    <i className="fas fa-shopping-bag text-2xl text-gray-700"></i>
                    {cartItemCount > 0 && 
                        <span className="absolute -top-1 -right-2 bg-pink-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center font-bold">
                            {cartItemCount}
                        </span>
                    }
                </button>
            </div>
        </nav>
    </header>
);

const ProductCard = ({ product, addToCart }) => (
    <div className="bg-white rounded-lg shadow-md overflow-hidden group">
        <div className="overflow-hidden relative">
            <img src={product.imageUrl} alt={product.name} className="w-full h-48 md:h-64 object-cover transition-transform duration-500 group-hover:scale-105" />
        </div>
        <div className="p-4 text-center">
            <h3 className="font-semibold text-lg">{product.name}</h3>
            <p className="text-pink-500 font-bold mt-1 text-xl">₹{product.price}</p>
            <button onClick={() => addToCart(product)} className="mt-3 w-full bg-gray-800 text-white text-sm font-bold py-2 px-4 rounded-full hover:bg-gray-900 transition-all transform hover:scale-105">
                Add to Cart
            </button>
        </div>
    </div>
);

const InstagramReel = ({ reelUrl }) => {
    const embedUrl = useMemo(() => {
        if (!reelUrl) return null;
        try {
            const url = new URL(reelUrl);
            const pathSegments = url.pathname.split('/').filter(Boolean); // e.g., ['p', 'Cxyz...'] or ['reels', 'Cxyz...']
            if (pathSegments.length >= 2) {
                const shortcode = pathSegments[1];
                return `https://www.instagram.com/p/${shortcode}/embed/`;
            }
            return null;
        } catch (error) {
            console.error("Invalid reel URL", error);
            return null;
        }
    }, [reelUrl]);

    if (!embedUrl) return null;

    return (
        <div className="aspect-[9/16] max-w-sm mx-auto rounded-xl overflow-hidden shadow-2xl">
            <iframe
                src={embedUrl}
                className="w-full h-full border-0"
                allowFullScreen
                scrolling="no"
                allow="autoplay; encrypted-media"
            ></iframe>
        </div>
    );
};

const HomePage = ({ products, addToCart, settings }) => (
    <>
      {settings.announcement && 
        <div className="bg-gray-800 text-white text-center py-2 px-4 text-sm font-semibold">
            ✨ {settings.announcement} ✨
        </div>
      }
      <main>
        <section className="bg-pink-50 py-16 md:py-24">
            <div className="container mx-auto px-4 sm:px-6 text-center">
                <h1 className="text-4xl md:text-6xl font-brand font-bold text-gray-900 leading-tight">Where Jewels Meet Elegance</h1>
                <p className="text-lg md:text-xl text-gray-700 mt-4 max-w-2xl mx-auto">Discover our exquisite collection of premium, long-lasting jewellery. <strong>Luxury that fits your budget.</strong></p>
                <a href="#bestsellers" className="mt-8 inline-block bg-gray-800 text-white font-bold py-3 px-8 rounded-full text-lg hover:scale-105 transform transition-transform">
                    Shop The Collection
                </a>
            </div>
        </section>
        
        <section id="bestsellers" className="py-16 md:py-20">
            <div className="container mx-auto px-4 sm:px-6">
                <div className="text-center mb-12">
                    <h2 className="text-3xl md:text-4xl font-brand font-bold text-gray-900">Our Bestsellers</h2>
                </div>
                {products.length === 0 ? <Spinner /> : 
                    <div className="grid grid-cols-2 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4 md:gap-6">
                        {products.map(p => <ProductCard key={p.id} product={p} addToCart={addToCart} />)}
                    </div>
                }
            </div>
        </section>

        <section id="reels" className="py-16 md:py-20 bg-pink-50">
            <div className="container mx-auto px-4 sm:px-6 text-center">
                <h2 className="text-3xl md:text-4xl font-brand font-bold text-gray-900">Get Inspired</h2>
                <p className="text-lg text-gray-600 mt-2 mb-8">See our latest designs in action!</p>
                <InstagramReel reelUrl={settings.reelUrl} />
            </div>
        </section>

        <section id="reviews" className="py-16 md:py-20">
            {/* Customer Reviews Section as before */}
            <div className="container mx-auto px-4 sm:px-6">
                 <div className="text-center mb-12">
                    <h2 className="text-3xl md:text-4xl font-brand font-bold text-gray-900">What Our Customers Say</h2>
                    <div className="flex justify-center items-center mt-2 text-yellow-400">
                        <StarRating rating={4.8} />
                        <span className="text-gray-600 ml-2">4.8 stars from 200+ reviews</span>
                    </div>
                </div>
                <div className="grid grid-cols-1 md:grid-cols-3 gap-8">
                    {/* Review Cards */}
                    <div className="bg-white p-6 rounded-lg shadow-lg">"Absolutely in love with my necklace from Zewa! The quality is amazing for the price. Looks so premium."<p className="font-bold mt-4">- Priya S.</p></div>
                    <div className="bg-white p-6 rounded-lg shadow-lg">"Finally, affordable jewellery that doesn't tarnish! I've been wearing my earrings daily and they still look brand new."<p className="font-bold mt-4">- Anjali K.</p></div>
                    <div className="bg-white p-6 rounded-lg shadow-lg">"The delivery was super fast too. Will definitely shop again from Zewa!"<p className="font-bold mt-4">- Sneha P.</p></div>
                </div>
            </div>
        </section>
      </main>
    </>
);

const CartPage = ({ cart, updateCartQuantity, removeFromCart, setView }) => {
    const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);
    
    return (
        <div className="container mx-auto p-4 md:p-8">
            <h1 className="text-3xl font-brand font-bold mb-6">Your Cart</h1>
            {cart.length === 0 ? (
                <div className="text-center py-12">
                    <p className="text-xl mb-4">Your cart is empty.</p>
                    <button onClick={() => setView('home')} className="bg-gray-800 text-white font-bold py-3 px-6 rounded-full">Continue Shopping</button>
                </div>
            ) : (
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-8">
                    <div className="lg:col-span-2 space-y-4">
                        {cart.map(item => (
                            <div key={item.id} className="flex items-center bg-white p-4 rounded-lg shadow-sm">
                                <img src={item.imageUrl} alt={item.name} className="w-20 h-20 object-cover rounded-md" />
                                <div className="flex-grow ml-4">
                                    <p className="font-bold">{item.name}</p>
                                    <p className="text-sm">₹{item.price}</p>
                                </div>
                                <div className="flex items-center">
                                    <input type="number" value={item.quantity} onChange={e => updateCartQuantity(item.id, parseInt(e.target.value))} min="1" className="w-16 p-1 border rounded-md text-center" />
                                </div>
                                <div className="ml-4 font-bold w-20 text-right">₹{item.price * item.quantity}</div>
                                <button onClick={() => removeFromCart(item.id)} className="ml-4 text-red-500"><i className="fas fa-trash"></i></button>
                            </div>
                        ))}
                    </div>
                    <div className="bg-white p-6 rounded-lg shadow-sm h-fit">
                        <h2 className="text-xl font-bold mb-4">Order Summary</h2>
                        <div className="flex justify-between mb-2"><p>Subtotal</p><p>₹{subtotal}</p></div>
                        <div className="flex justify-between mb-4"><p>Shipping</p><p>FREE</p></div>
                        <hr className="my-2"/>
                        <div className="flex justify-between font-bold text-lg"><p>Total</p><p>₹{subtotal}</p></div>
                        <button onClick={() => setView('checkout')} className="mt-6 w-full bg-pink-500 text-white font-bold py-3 rounded-full hover:bg-pink-600 transition-colors">Proceed to Checkout</button>
                    </div>
                </div>
            )}
        </div>
    );
};

const CheckoutPage = ({ cart, placeOrder }) => {
    const [customer, setCustomer] = useState({ name: '', email: '', phone: '', address: '', city: '', pincode: '' });
    const subtotal = cart.reduce((sum, item) => sum + item.price * item.quantity, 0);

    const handleSubmit = (e) => {
        e.preventDefault();
        placeOrder(customer);
    };
    
    const handleChange = (e) => {
        setCustomer({ ...customer, [e.target.name]: e.target.value });
    };

    return (
        <div className="container mx-auto p-4 md:p-8">
            <h1 className="text-3xl font-brand font-bold mb-6">Checkout</h1>
            <div className="grid grid-cols-1 md:grid-cols-2 gap-12">
                <form onSubmit={handleSubmit}>
                    <h2 className="text-xl font-bold mb-4">Shipping Information</h2>
                    <div className="grid grid-cols-1 sm:grid-cols-2 gap-4">
                        <input name="name" onChange={handleChange} placeholder="Full Name" className="p-2 border rounded-lg sm:col-span-2" required />
                        <input name="email" type="email" onChange={handleChange} placeholder="Email" className="p-2 border rounded-lg" required />
                        <input name="phone" type="tel" onChange={handleChange} placeholder="Phone Number" className="p-2 border rounded-lg" required />
                        <input name="address" onChange={handleChange} placeholder="Address" className="p-2 border rounded-lg sm:col-span-2" required />
                        <input name="city" onChange={handleChange} placeholder="City" className="p-2 border rounded-lg" required />
                        <input name="pincode" onChange={handleChange} placeholder="Pincode" className="p-2 border rounded-lg" required />
                    </div>
                    <h2 className="text-xl font-bold mt-8 mb-4">Payment</h2>
                    <div className="p-4 border rounded-lg bg-gray-50">
                        <p className="font-semibold">Payment Gateway</p>
                        <p className="text-sm text-gray-600">After clicking 'Place Order', you will be redirected to our secure payment partner (Razorpay/Stripe) to complete your purchase.</p>
                        <p className="text-center font-bold text-blue-600 mt-2">(This is a demo. No payment will be processed.)</p>
                    </div>
                     <button type="submit" className="mt-6 w-full bg-gray-800 text-white font-bold py-3 rounded-full hover:bg-gray-900 transition-colors">Place Order</button>
                </form>
                <div className="bg-white p-6 rounded-lg shadow-sm h-fit">
                    <h2 className="text-xl font-bold mb-4">Your Order</h2>
                    <div className="space-y-2">
                        {cart.map(item => (
                            <div key={item.id} className="flex justify-between items-center text-sm">
                                <div className="flex items-center">
                                  <img src={item.imageUrl} className="w-10 h-10 object-cover rounded-md mr-3" />
                                  <span>{item.name} x {item.quantity}</span>
                                </div>
                                <span>₹{item.price * item.quantity}</span>
                            </div>
                        ))}
                    </div>
                    <hr className="my-4"/>
                    <div className="flex justify-between font-bold text-lg"><p>Total</p><p>₹{subtotal}</p></div>
                </div>
            </div>
        </div>
    );
};

const OrderConfirmationPage = ({ setView }) => (
    <div className="container mx-auto p-8 text-center">
        <div className="bg-white p-12 rounded-lg shadow-lg max-w-lg mx-auto">
            <i className="fas fa-check-circle text-green-500 text-6xl mb-4"></i>
            <h1 className="text-3xl font-brand font-bold mb-2">Thank You!</h1>
            <p className="text-xl text-gray-700">Your order has been placed successfully.</p>
            <p className="mt-4 text-gray-600">You will receive an email confirmation shortly with your order details.</p>
            <button onClick={() => setView('home')} className="mt-8 bg-gray-800 text-white font-bold py-3 px-8 rounded-full">Continue Shopping</button>
        </div>
    </div>
);


// --- Main App Component ---
export default function App() {
    // Routing State
    const [view, setView] = useState('home');

    // Data State
    const [products, setProducts] = useState([]);
    const [orders, setOrders] = useState([]);
    const [settings, setSettings] = useState({ announcement: '', reelUrl: '' });
    
    // Auth State
    const [user, setUser] = useState(null);
    const [loadingAuth, setLoadingAuth] = useState(true);
    
    // Cart State
    const [cart, setCart] = useState(() => {
        const savedCart = localStorage.getItem('zewaCart');
        return savedCart ? JSON.parse(savedCart) : [];
    });

    // --- Effects for Data Fetching and Auth ---

    useEffect(() => {
        // Auth observer
        const unsubscribe = onAuthStateChanged(auth, (currentUser) => {
            setUser(currentUser);
            setLoadingAuth(false);
        });
        return () => unsubscribe();
    }, []);

    useEffect(() => {
        // Firestore listeners
        const unsubProducts = onSnapshot(query(collection(db, 'products'), orderBy('createdAt', 'desc')), (snapshot) => {
            setProducts(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });
        const unsubOrders = onSnapshot(query(collection(db, 'orders'), orderBy('createdAt', 'desc')), (snapshot) => {
            setOrders(snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() })));
        });
        const unsubSettings = onSnapshot(doc(db, 'settings', 'site'), (doc) => {
            if (doc.exists()) {
                setSettings(doc.data());
            }
        });
        
        return () => { unsubProducts(); unsubOrders(); unsubSettings(); };
    }, []);
    
    // --- Routing Effect ---
    useEffect(() => {
        const handleHashChange = () => {
            const hash = window.location.hash.replace('#', '');
            if (hash.startsWith('admin')) {
                setView('admin');
            } else if (['cart', 'checkout', 'confirmation'].includes(hash)) {
                setView(hash);
            } else {
                setView('home');
            }
        };
        window.addEventListener('hashchange', handleHashChange);
        handleHashChange(); // Initial check
        return () => window.removeEventListener('hashchange', handleHashChange);
    }, []);

    const updateView = (newView) => {
        window.location.hash = newView;
    };
    
    // --- Cart Logic ---

    useEffect(() => {
        localStorage.setItem('zewaCart', JSON.stringify(cart));
    }, [cart]);

    const addToCart = (product) => {
        setCart(prevCart => {
            const existingItem = prevCart.find(item => item.id === product.id);
            if (existingItem) {
                return prevCart.map(item => item.id === product.id ? { ...item, quantity: item.quantity + 1 } : item);
            }
            return [...prevCart, { ...product, quantity: 1 }];
        });
    };

    const updateCartQuantity = (productId, quantity) => {
        if (quantity < 1) return;
        setCart(cart.map(item => item.id === productId ? { ...item, quantity } : item));
    };

    const removeFromCart = (productId) => {
        setCart(cart.filter(item => item.id !== productId));
    };

    const placeOrder = async (customer) => {
        if (cart.length === 0) return;
        const orderData = {
            customer,
            items: cart,
            total: cart.reduce((sum, item) => sum + item.price * item.quantity, 0),
            createdAt: new Date(),
            status: 'Pending'
        };
        try {
            await addDoc(collection(db, 'orders'), orderData);
            setCart([]);
            updateView('confirmation');
        } catch (error) {
            console.error("Error placing order: ", error);
            alert("Sorry, there was an issue placing your order. Please try again.");
        }
    };

    const cartItemCount = cart.reduce((sum, item) => sum + item.quantity, 0);

    // --- Render Logic ---

    if (loadingAuth) {
        return <div className="h-screen w-screen flex justify-center items-center"><Spinner /></div>;
    }

    if (view === 'admin') {
        return user ? <AdminDashboard products={products} orders={orders} settings={settings} setSettings={setSettings} /> : <AdminLogin />;
    }

    return (
        <div className="bg-pink-50 min-h-screen font-sans">
            <Header cartItemCount={cartItemCount} setView={updateView} />
            {view === 'home' && <HomePage products={products} addToCart={addToCart} settings={settings} />}
            {view === 'cart' && <CartPage cart={cart} updateCartQuantity={updateCartQuantity} removeFromCart={removeFromCart} setView={updateView} />}
            {view === 'checkout' && <CheckoutPage cart={cart} placeOrder={placeOrder} />}
            {view === 'confirmation' && <OrderConfirmationPage setView={updateView} />}
            {/* Footer can go here */}
        </div>
    );
}
